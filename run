#!/bin/sh -e

frontend_run() {
    docker compose run --rm frontend $*
}

backend_run() {
    docker compose run --rm backend $*
}

e2e_run() {
    docker compose build e2e
    docker compose run --rm e2e $*
}

lint() {
    frontend_run npm run lint
    frontend_run npm run typecheck
    backend_run python -m flake8
    backend_run python -m mypy .
    e2e_run python -m flake8
}

format() {
    frontend_run npm run format
    backend_run python -m black --line-length 79 .
    e2e_run python -m black --line-length 79 .
}

unit_test() {
    backend_run python -m pytest
    frontend_run npm run test -- --run
}

e2e() {
    backend_run python manage.py flush --no-input
    backend_run python manage.py seed
    e2e_run python -m pytest $*
}

debug_e2e() {
    backend_run python manage.py flush --no-input
    backend_run python manage.py seed
    set -o allexport
    . ./.env
    set +o allexport
    . env/bin/activate
    cd e2e
    E2E_HOST=http://localhost:3000 PWDEBUG=1 python -m pytest $*
    deactivate
}

dev() {
    docker compose up --build -d
}

if [ $# -eq 0 ]; then
    command=dev
else
    command=$1
    shift
fi

case $command in
    dev) dev ;;
    restart) docker-compose down && dev ;;
    lint) lint ;;
    format) format ;;
    test) unit_test ;;
    migrate) backend_run python manage.py migrate ;;
    e2e) e2e $* ;;
    debug-e2e) debug_e2e $* ;;
    stop) docker-compose down ;;
    rm) docker-compose down -v ;;
    *)
        echo "$0: Unrecognised command (see script for options): $command" >&2
        exit 1
        ;;
esac
